<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>STIG Analysis - Cybersecurity Management Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="../styles.css" />
</head>
<body>
  <!-- Navigation will be inserted by navigation.js -->

  <header class="page-header">
    <div class="header-content">
      <h1>STIG → NIST Control Mapper</h1>
      <p>Import and analyze STIG files to map vulnerabilities to NIST controls</p>
    </div>
    
    <div class="file-loader">
      <label for="cklbFile" class="btn">Load STIG Files</label>
      <input id="cklbFile" type="file" accept=".json,.cklb,.ckl,.xml,application/json,application/xml" multiple />
      <span id="fileName" class="file-name">No files selected</span>
      <div id="fileList" class="file-list" style="display: none;"></div>
      
      <label for="cciFile" class="btn btn-secondary">Load CCI List XML (Optional)</label>
      <input id="cciFile" type="file" accept=".xml,application/xml" />
      <span id="cciFileName" class="file-name">Built-in mapping active</span>
    </div>
  </header>

  <main class="app-main">
    <section class="filters">
      <div class="filter-row">
        <div class="filter">
          <label for="familySelect">NIST Family</label>
          <select id="familySelect">
            <option value="">All</option>
          </select>
        </div>

        <div class="filter">
          <label for="controlSelect">NIST Control</label>
          <select id="controlSelect">
            <option value="">All</option>
          </select>
        </div>

        <div class="filter">
          <label for="severitySelect">Severity</label>
          <select id="severitySelect">
            <option value="">All</option>
            <option value="low">low</option>
            <option value="medium">medium</option>
            <option value="high">high</option>
            <option value="critical">critical</option>
          </select>
        </div>

        <div class="filter">
          <label for="statusSelect">Status</label>
          <select id="statusSelect">
            <option value="">All</option>
            <option value="open">open</option>
            <option value="not_a_finding">not_a_finding</option>
            <option value="not_applicable">not_applicable</option>
            <option value="failed">failed</option>
            <option value="passed">passed</option>
            <option value="not_reviewed">not_reviewed</option>
          </select>
        </div>

        <div class="filter">
          <label for="stigSelect">STIG Name</label>
          <select id="stigSelect">
            <option value="">All</option>
          </select>
        </div>

        <div class="filter">
          <label for="cciInput">CCI</label>
          <input id="cciInput" type="text" placeholder="e.g., CCI-000366" />
        </div>
      </div>

      <div class="filter-row">
        <div class="filter search-filter">
          <label for="searchInput">Free-text search</label>
          <input id="searchInput" type="search" placeholder="Search title, discussion, details, etc." />
        </div>
        <div class="filter">
          <button id="exportBtn" class="btn btn-export" data-ui-button data-variant="info" disabled>
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8.5 6.5a.5.5 0 0 0-1 0v3.793L6.354 9.146a.5.5 0 1 0-.708.708l2 2a.5.5 0 0 0 .708 0l2-2a.5.5 0 0 0-.708-.708L8.5 10.293V6.5z"/>
              <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            Export to Excel
          </button>
        </div>
        <div class="filter">
          <button id="exportMappingsBtn" class="btn btn-export" data-ui-button data-variant="info" disabled title="Export CCI/STIG mappings for POAM import">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
            </svg>
            Export Mappings
          </button>
        </div>
        <div class="filter">
          <button id="importMappingsBtn" class="btn btn-import" data-ui-button data-variant="success" title="Import CCI/STIG mappings from exported JSON file">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
              <path d="M8.5 9.5a.5.5 0 0 1-1 0V3.707L6.354 4.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 3.707V9.5z"/>
              <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
            </svg>
            Import Mappings
          </button>
          <input id="importMappingsFile" type="file" accept=".json,application/json" style="display: none;" />
        </div>
      </div>
    </section>

    <section class="results">
      <div class="table-wrap">
        <table id="resultsTable">
          <thead>
            <tr>
              <th class="expand-col"></th>
              <th data-key="nistControls" class="sortable">
                NIST Control(s)
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="ccis" class="sortable">
                CCI(s)
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="group_id" class="sortable">
                Vuln-ID
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="rule_id" class="sortable">
                Rule-ID
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="rule_version" class="sortable">
                Rule Version
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="rule_title" class="sortable">
                Title
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="severity" class="sortable">
                Severity
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="status" class="sortable">
                Status
                <span class="sort-indicator">↕</span>
              </th>
              <th data-key="stig_name" class="sortable">
                STIG Name
                <span class="sort-indicator">↕</span>
              </th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
      <div id="emptyState" class="empty-state" hidden>
        Load a CKLB JSON or CKL XML file to view and filter NIST mappings.
      </div>
      <div id="noResultsState" class="empty-state" hidden>
        No results match your filters.
      </div>
    </section>
  </main>

  <footer class="app-footer">
    <small>Client-side only. Data persisted locally in your browser.</small>
  </footer>

  <!-- Core Systems (load first) -->
  <script src="../scripts/app-state.js"></script>
  <script src="../scripts/data-manager.js"></script>
  
  <!-- Core functionality modules -->
  <script src="../scripts/importer.js"></script>
  <script src="../scripts/vuln-table.js"></script>
  <!-- ExcelJS CDN for browser XLSX export -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="../scripts/excel-export.js"></script>
  <script src="../scripts/export-import-manager.js"></script>
  
  <!-- UI Framework and Components -->
  <link rel="stylesheet" href="../components/ui-components.css">
  <script src="../components/ui-framework.js"></script>
  <script src="../components/icon-library.js"></script>
  <script src="../components/ui-components.js"></script>
  <script src="../components/table-component.js"></script>
  <script src="../components/layout-components.js"></script>
  <!-- Progressive Button Migration (opt-in via data-ui-button) -->
  <script src="../components/button-migration.js"></script>
  
  <!-- Navigation and Application-specific UI components -->
  <script src="../components/navigation.js"></script>
  <script src="../components/status-messages.js"></script>
  <script src="../components/filter-panel.js"></script>
  <script src="../components/file-loader.js"></script>
  
  <!-- Main application controller -->
  <script src="../scripts/app.js"></script>
  
  <!-- Application initialization -->
  <script>
    // Initialize the STIG analysis page
    document.addEventListener('DOMContentLoaded', async () => {
      try {
        // Initialize the application using the new state manager
        await AppState.initialize();
        
        // Setup STIG-specific functionality
        setupExportMappings();
        setupImportMappings();
        
        console.log('STIG Analysis Page ready!');
        
      } catch (error) {
        console.error('Failed to initialize STIG analysis page:', error);
        // Error handling is managed by AppState
      }
    });

    // Setup export mappings functionality
    function setupExportMappings() {
      const exportMappingsBtn = document.getElementById('exportMappingsBtn');

      if (exportMappingsBtn) {
        exportMappingsBtn.addEventListener('click', async () => {
          try {
            // Check for data availability from multiple sources
            let stigData = null;
            let dataManager = null;

            if (window.app && window.app.state.allRows && window.app.state.allRows.length > 0) {
              stigData = window.app.state.allRows;
              dataManager = AppState?.state?.dataManager;
            } else if (AppState?.state?.dataManager) {
              dataManager = AppState.state.dataManager;
              try {
                stigData = await dataManager.getAllStigRows();
              } catch (error) {
                console.warn('Could not get STIG data from DataManager:', error);
              }
            }

            if (!stigData || stigData.length === 0) {
              alert('No STIG data available to export. Please import STIG files first.');
              return;
            }

            if (!dataManager) {
              alert('Data manager not available. Please ensure the application is fully loaded.');
              return;
            }

            // Export Mappings only exports JSON format (for POAM import)
            const format = 'json';
            const exportManager = new ExportImportManager();

            // Show progress
            exportMappingsBtn.disabled = true;
            exportMappingsBtn.innerHTML = 'Exporting...';

            const result = await exportManager.exportCciStigMappings(dataManager, {
              format: format,
              includeMetadata: true,
              includePoams: false
            });

            if (result.success) {
              let message = `Export completed successfully!\n\n`;
              message += `Format: ${result.format.toUpperCase()}\n`;
              message += `File: ${result.filename}\n`;
              message += `Records: ${result.recordCount}\n`;

              if (result.localPath) {
                message += `Saved to: ${result.localPath}\n`;
              }

              message += `\nImport this file in the POAM Management page to create POAMs from these vulnerabilities.`;

              alert(message);

              // Show success message via status messages if available
              if (window.app && window.app.modules && window.app.modules.statusMessages) {
                window.app.modules.statusMessages.showSuccess(
                  `CCI/STIG mappings exported successfully (${result.recordCount} records)`
                );
              }
            }

          } catch (error) {
            console.error('Export mappings failed:', error);
            alert(`Export failed: ${error.message}`);

            if (window.app && window.app.modules && window.app.modules.statusMessages) {
              window.app.modules.statusMessages.showError(`Export failed: ${error.message}`);
            }
          } finally {
            // Restore button
            exportMappingsBtn.disabled = false;
            exportMappingsBtn.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8 1a2.5 2.5 0 0 1 2.5 2.5V4h-5v-.5A2.5 2.5 0 0 1 8 1zm3.5 3v-.5a3.5 3.5 0 1 0-7 0V4H1v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V4h-3.5zM2 5h12v9a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V5z"/>
              </svg>
              Export Mappings
            `;
          }
        });
      }
    }

    // Setup import mappings functionality
    function setupImportMappings() {
      const importMappingsBtn = document.getElementById('importMappingsBtn');
      const importMappingsFile = document.getElementById('importMappingsFile');

      if (importMappingsBtn && importMappingsFile) {
        // Click button to trigger file selection
        importMappingsBtn.addEventListener('click', () => {
          importMappingsFile.click();
        });

        // Handle file selection
        importMappingsFile.addEventListener('change', async (event) => {
          const file = event.target.files[0];
          if (!file) return;

          console.log('Import Mappings - Debugging app availability:', {
            windowApp: !!window.app,
            appState: window.AppState ? 'available' : 'not available',
            stigApp: !!(window.AppState && window.AppState.getComponent && window.AppState.getComponent('stigApp')),
            stigAppHandleFileUpload: !!(window.AppState && window.AppState.getComponent && window.AppState.getComponent('stigApp') && window.AppState.getComponent('stigApp').handleFileUpload)
          });

          try {
            // Show progress
            importMappingsBtn.disabled = true;
            importMappingsBtn.innerHTML = 'Importing...';

            // Use the STIG app's file upload handler if available
            if (window.AppState && window.AppState.getComponent) {
              const stigApp = window.AppState.getComponent('stigApp');
              if (stigApp && typeof stigApp.handleFileUpload === 'function') {
                // Create a fake event object for the app's handler
                const fakeEvent = { target: { files: [file] } };
                await stigApp.handleFileUpload(fakeEvent);

                // Show success message
                alert(`Successfully imported ${file.name}!\n\nThe STIG data has been loaded and is ready for analysis.`);

                if (stigApp.modules && stigApp.modules.statusMessages) {
                  stigApp.modules.statusMessages.showSuccess(`Imported mappings from ${file.name}`);
                }
              } else {
                throw new Error('STIG application not ready for file import');
              }
            } else {
              throw new Error('AppState not available');
            }

          } catch (error) {
            console.error('Import mappings failed:', error);
            alert(`Import failed: ${error.message}`);

            if (window.app && window.app.modules && window.app.modules.statusMessages) {
              window.app.modules.statusMessages.showError(`Import failed: ${error.message}`);
            }
          } finally {
            // Restore button
            importMappingsBtn.disabled = false;
            importMappingsBtn.innerHTML = `
              <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
                <path d="M8.5 9.5a.5.5 0 0 1-1 0V3.707L6.354 4.854a.5.5 0 1 1-.708-.708l2-2a.5.5 0 0 1 .708 0l2 2a.5.5 0 0 1-.708.708L8.5 3.707V9.5z"/>
                <path d="M14 14V4.5L9.5 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2zM9.5 3A1.5 1.5 0 0 0 11 4.5h2V14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h5.5v2z"/>
              </svg>
              Import Mappings
            `;
            
            // Clear the file input
            importMappingsFile.value = '';
          }
        });
      }
    }

    function showFallbackError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #dc3545;
        color: white;
        padding: 15px 20px;
        border-radius: 5px;
        z-index: 10000;
        font-family: system-ui, -apple-system, sans-serif;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      errorDiv.textContent = message;
      document.body.appendChild(errorDiv);

      setTimeout(() => {
        if (errorDiv.parentNode) {
          errorDiv.parentNode.removeChild(errorDiv);
        }
      }, 10000);
    }
  </script>
</body>
</html>